
AWSTemplateFormatVersion: '2010-09-09'


Parameters:

  GlobalTag:
    Type: String
    Description: >
      A common value that all resources in this template will have prefixed to
      their name and attached as a tag to establish a bundling through naming convention.
    Default: kuali-dms-oracle

  Landscape:
    Description: Specify a name for your landscape
    Type: String
    AllowedPattern: "[a-zA-Z\\d]{1,12}"
    ConstraintDescription: Up to 12 letters and/or numbers
    
  Service:
    Description: Service catalog name
    Type: String
    Default: research-administration

  Function:
    Description: The Function within the Service
    Type: String
    Default: kuali

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The id of the vpc to deploy to.

  ReplicationInstanceAZ:
    Type: String
    Description: The availablility zone for the replication instance.

  SubnetId1:
    # Type: AWS::EC2::Subnet::Id
    Type: String
    Description: Subnet associated with the source oracle database endpoint.
    Default: empty

  SubnetId2:
    # Type: AWS::EC2::Subnet::Id
    Type: String
    Description: Subnet associated with the target RDS oracle database endpoint.
    Default: empty
      
  SourceSecurityGroup:
    # Type: AWS::EC2::SecurityGroup::Id
    Type: String
    Description: The security group of the source oracle database endpoint.
    Default: empty
      
  TargetSecurityGroup:
    # Type: AWS::EC2::SecurityGroup::Id
    Type: String
    Description: The security group of the target RDS oracle database endpoint.
    Default: empty

  ReplicationInstanceAllocatedStorage:
    Type: Number
    Description: >
        The amount of storage (in gigabytes) to be initially allocated for the replication instance.
    Default: 100

  # https://docs.aws.amazon.com/dms/latest/userguide/CHAP_ReplicationInstance.InDepth.html
  ReplicationInstanceClass:
    Type: String
    Description: >
      The compute and memory capacity of the replication instance.
      AllowedValues:
        - dms.t2.micro
        - dms.t2.small
        - dms.t2.medium
        - dms.t2.large
        - dms.c4.large
        - dms.c4.xlarge
        - dms.c4.2xlarge
        - dms.c4.4xlarge
        - dms.r4.large
        - dms.r4.xlarge
        - dms.r4.2xlarge
        - dms.r4.4xlarge
    Default: dms.r4.large

  DbSchemaName:
    Type: String
    Description: Name of the database Schema to be migrated
    Default: KCOEUS

  # SourceDbName:
  #   Type: String
  #   Description: Source database name
  #   Default: Kuali

  # SourceDbUsername:
  #   Type: String
  #   Description: Source database username
  #   Default: AWS_DMS

  # SourceDbPassword:
  #   Type: String
  #   Description: Source database password
  #   NoEcho: true

  SourceDbEngine:
    Type: String
    Description: Source database engine. Valid values depend on the EndpointType value.
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - redshift
      - s3
      - db2
      - azuredb
      - sybase
      - dynamodb
      - mongodb
      - sqlserver
    Default: oracle

  # SourceDbServerName:
  #   Type: String
  #   Description: Source database hostname

  # SourceDbPort:
  #   Type: Number
  #   Description: Source database connection port number
  #   Default: 1521

  TargetDbName:
    Type: String
    Description: Target database name
    Default: Kuali

  TargetDbEngine:
    Type: String
    Description: Target database engine. Valid values depend on the EndpointType value.
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - redshift
      - s3
      - db2
      - azuredb
      - sybase
      - dynamodb
      - mongodb
      - sqlserver
    Default: oracle

  TargetDbServerName:
    Type: String
    Description: Target database hostname

  TargetDbPort:
    Type: Number
    Description: Target database connection port number
    Default: 1521

  MigrationType:
    Type: String
    Description: The migration type.
    AllowedValues:
      - full-load
      - cdc
      - full-load-and-cdc
    Default: full-load

  TargetTablePrepMode:
    Type: String
    Description: >
      To indicate how to handle loading the target at full-load startup, specify one of 
      the following values for the TargetTablePrepMode option
    AllowedValues:
      - DO_NOTHING
      - DROP_AND_CREATE 
      - TRUNCATE_BEFORE_LOAD
    Default: TRUNCATE_BEFORE_LOAD

  EnableLogging: 
    Type: String
    Description: Use CloudWatch to log information during the migration process
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  EnableValidation: 
    Type: String
    Description: Enables data validation when set to true. Otherwise, validation is disabled for the task
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  ValidationOnly: 
    Type: String
    Description: |
      When this option is set to true, the task previews data validation without performing any migration or replication of data.
      ValidationOnly set to true is particularly useful for the following use cases 
      1) After data was migrated in a separate full load task without validation enabled, you can validate data without performing 
      another full load. Just create and run another task with ValidationOnly set to true.
      2) During a full load task, validation only begins once the initial load is complete. But, by creating a separate ValidationOnly 
      task, you can see early validation results and resolve any failures prior to actually moving all of the data. 
      This approach can be more efficient than waiting to resolve failures after all the source data has been migrated to the target.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"

  RecoverableErrorCount:
    Type: Number
    Description: | 
      The maximum number of attempts made to restart a task when an environmental error occurs. After the system attempts to restart 
      the task the designated number of times, the task is stopped and manual intervention is required. The default value is -1, 
      which instructs AWS DMS to attempt to restart the task indefinitely. Set this value to 0 to never attempt to restart a task. 
      If a fatal error occurs, AWS DMS stops attempting to restart the task after six attempts.
    Default: 0

  FailOnTransactionConsistencyBreached:
    Type: String
    Description: |
      This option applies to tasks using Oracle as a source with CDC. Set it to true to cause a task to fail when a transaction is 
      open for more time than the specified timeout and can be dropped. When a CDC task starts with Oracle, AWS DMS waits for a limited 
      time for the oldest open transaction to close before starting CDC. If the oldest open transaction doesn't close until the timeout 
      is reached, then in most cases AWS DMS starts CDC, ignoring that transaction. If this option is set to true, the task fails.
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  CreateDmsVpcRole:
    Type: String
    Description: Role to grant the dms service various networking privileges.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"

  CreateDmsCloudwatchLogsRole:
    Type: String
    Description: Role to grant the dms service logging privileges.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"

  CreateDmsAccessForTasksRole:
    Type: String
    Description: Role to grant the dms service privileges for data type assessment reports and their s3 storage.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"


Mappings:

  # For loading multiple tables in parallel. The higher the instance type, the greater the capacity to handle more parallel operations.
  ParallelLoadMap:
    dms.t2.micro:
      parallelTasks: 2
    dms.t2.small:
      parallelTasks: 4
    dms.t2.medium:
      parallelTasks: 6
    dms.t2.large:
      parallelTasks: 8
    dms.c4.large:
      parallelTasks: 8
    dms.c4.xlarge:
      parallelTasks: 12
    dms.c4.2xlarge:
      parallelTasks: 16
    dms.c4.4xlarge:
      parallelTasks: 20
    dms.r4.large:
      parallelTasks: 8
    dms.r4.xlarge:
      parallelTasks: 12
    dms.r4.2xlarge:
      parallelTasks: 20
    dms.r4.4xlarge:
      parallelTasks: 20


Conditions:
  # Subnet conditions
  SubnetId1Provided: !Not [!Equals [!Ref SubnetId1, empty]]
  SubnetId2Provided: !Not [!Equals [!Ref SubnetId2, empty]]
  BothSubnetsProvided: !And [Condition: SubnetId1Provided, Condition: SubnetId2Provided]
  # SecurityGroup conditions
  SourceSecurityGroupProvided: !Not [!Equals [!Ref SourceSecurityGroup, empty]]
  TargetSecurityGroupProvided: !Not [!Equals [!Ref TargetSecurityGroup, empty]]
  AnySecurityGroupProvided: !Or [Condition: SourceSecurityGroupProvided, Condition: TargetSecurityGroupProvided]
  IncludeDmsVpcRole: !Equals [!Ref CreateDmsVpcRole, 'true']
  IncludeDmsCloudwatchLogsRole: !Equals [!Ref CreateDmsCloudwatchLogsRole, 'true']
  IncludeDmsAccessForTasksRole: !Equals [!Ref CreateDmsAccessForTasksRole, 'true']

Resources:

  DMSVpcRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Retain
    Condition: IncludeDmsVpcRole
    Properties:
      RoleName: !Sub dms-vpc-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - dms.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonDMSVPCManagementRole

  DMSCloudwatchLogsRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Retain
    Condition: IncludeDmsCloudwatchLogsRole
    Properties:
      RoleName: !Sub dms-cloudwatch-logs-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - dms.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonDMSCloudWatchLogsRole

  DMSS3AccessRole: 
    Type: AWS::IAM::Role
    DeletionPolicy: Retain
    Condition: IncludeDmsAccessForTasksRole
    Properties:
      RoleName: !Sub dms-access-for-tasks
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - dms.amazonaws.com
            Action: 
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonDMSRedshiftS3Role


  DMSSubnetGroup:
    Type: AWS::DMS::ReplicationSubnetGroup
    Condition: BothSubnetsProvided
    # NOTE: Cannot conditionally set DependsOn, so using workaround method by conditionally including DMSVpcRole.RoleId
    #       in the ReplicationSubnetGroupDescription to force this resource to wait for DMSVpcRole creation.
    # DependsOn: 
    #   !If
    #     - IncludeDmsVpcRole
    #     - DMSVpcRole
    #     - !Ref AWS::NoValue
    Properties:
      ReplicationSubnetGroupDescription: 
        !If
          - IncludeDmsVpcRole
          - !Sub 
            - ${gt}-${ls} DMS Subnet Group, New role - ${nr}
            - gt: !Ref GlobalTag
              ls: !Ref Landscape
              nr: !GetAtt DMSVpcRole.RoleId
          - !Sub 
            - ${gt}-${ls} DMS Subnet Group, New role - ${nr}
            - gt: !Ref GlobalTag
              ls: !Ref Landscape
              nr: 'None - role already exists'
      ReplicationSubnetGroupIdentifier: !Sub ${GlobalTag}-${Landscape}-dms-subnet-group
      SubnetIds:
        !If 
          - BothSubnetsProvided
          - - !Ref SubnetId1
            - !Ref SubnetId2
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub ${GlobalTag}-${Landscape}-dms-subnet-group
        - Key: Service
          Value: !Ref Service
        - Key: Function
          Value: !Ref Function


  DMSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: AnySecurityGroupProvided
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Security group for DMS replication instance
      Tags:
        - Key: Name
          Value: !Sub ${GlobalTag}-${Landscape}-dms-security-group
        - Key: Service
          Value: !Ref Service
        - Key: Function
          Value: !Ref Function

  # If SourceSecurityGroup is provided as a parameter, it is assumed that it was created somewhere else in the overall stack.
  # This is because we are modifying it by applying this ingress rule to it and you cannot do that for resources that are not
  # part of this stack or exist as a member or another stack (NOTE: You can import non-stack resources as long as you don't try to modify them)
  # If SourceSecurityGroup is ommitted as a parameter, it is assumed that the corresponding resource exists somewhere, but does not
  # need to have an ingress rule for a migration instance security group added because it already accepts all ips on the corresponding
  # port or from a cidr block that includes the migration instance anyway. 
  DMStoSourceSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: SourceSecurityGroupProvided
    Properties:
      Description: EC2 ingress from DMS
      FromPort: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:port}}'
      GroupId: !Ref SourceSecurityGroup
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref DMSSecurityGroup
      ToPort: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:port}}'

  # Same comments apply here as for DMStoSourceSecurityGroupIngress
  DMStoTargetSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: TargetSecurityGroupProvided
    Properties:
      Description: RDS ingress from DMS
      FromPort: !Ref TargetDbPort
      GroupId: !Ref TargetSecurityGroup
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref DMSSecurityGroup
      ToPort: !Ref TargetDbPort

  ReplicationInstance:
    Type: AWS::DMS::ReplicationInstance
    Properties:
      AllocatedStorage: !Ref ReplicationInstanceAllocatedStorage
      AllowMajorVersionUpgrade: false
      AutoMinorVersionUpgrade: false
      AvailabilityZone: !Ref ReplicationInstanceAZ
      MultiAZ: false
      PubliclyAccessible: false
      ReplicationInstanceClass: !Sub ${ReplicationInstanceClass}
      ReplicationInstanceIdentifier: !Sub '${GlobalTag}-${Landscape}-replication-instance'
      ReplicationSubnetGroupIdentifier: 
        !If
          - BothSubnetsProvided
          - !Ref DMSSubnetGroup
          - !Ref AWS::NoValue
      VpcSecurityGroupIds:
        !If
          - AnySecurityGroupProvided
          - - !Ref DMSSecurityGroup
          - !Ref AWS::NoValue

  SourceEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
      DatabaseName: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:sid}}'
      EndpointType: 'source'
      EngineName: !Ref SourceDbEngine
      ServerName: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:host}}'
      Port: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:port}}'
      Username: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:username}}'
      Password: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-ec2-dms-password:SecretString:password}}'
      ExtraConnectionAttributes: useLogMinerReader=N;useBfile=Y;
      Tags: 
        - Key: Name
          Value: !Sub ${GlobalTag}-${Landscape}-dms-source-endpoint
        - Key: Version
          Value: 1
        - Key: Service
          Value: !Ref Service
        - Key: Function
          Value: !Ref Function

  TargetEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
      DatabaseName: !Ref TargetDbName
      EndpointType: 'target'
      EngineName: !Ref TargetDbEngine
      ServerName: !Ref TargetDbServerName
      Port: !Ref TargetDbPort
      Username: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-rds-admin-password:SecretString:MasterUsername}}'
      Password: !Sub '{{resolve:secretsmanager:kuali/${Landscape}/kuali-oracle-rds-admin-password:SecretString:MasterUserPassword}}'
      Tags: 
        - Key: Name
          Value: !Sub ${GlobalTag}-${Landscape}-dms-target-endpoint
        - Key: Version
          Value: 1
        - Key: Service
          Value: !Ref Service
        - Key: Function
          Value: !Ref Function

  ReplicationTask:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: !Ref MigrationType
      ReplicationInstanceArn: !Ref ReplicationInstance
      ReplicationTaskIdentifier: !Sub ${GlobalTag}-${Landscape}-dms-replication-task
      SourceEndpointArn: !Ref SourceEndpoint
      TargetEndpointArn: !Ref TargetEndpoint
      Tags:
        - Key: Name
          Value: !Sub ${GlobalTag}-${Landscape}-dms-replication-task
        - Key: Service
          Value: !Ref Service
        - Key: Function
          Value: !Ref Function
      # https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Tasks.CustomizingTasks.TableMapping.html
      TableMappings: 
        !Sub
          - |-
            {
              "rules": [
                    {
                      "rule-type": "selection",
                      "rule-id": "1",
                      "rule-name": "1",
                      "object-locator": {
                          "schema-name": "${db_schema_name}",
                          "table-name": "BU_TEMP_%",
                          "table-type": "table"
                        },
                      "rule-action": "exclude"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "2",
                      "rule-name": "2",
                      "object-locator": {
                          "schema-name": "${db_schema_name}",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "3",
                      "rule-name": "3",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "${db_schema_name}"
                      },
                      "value": "${db_schema_name}"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "4",
                      "rule-name": "4",
                      "object-locator": {
                          "schema-name": "SAPBWKCRM",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "5",
                      "rule-name": "5",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "SAPBWKCRM"
                      },
                      "value": "SAPBWKCRM"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "6",
                      "rule-name": "6",
                      "object-locator": {
                          "schema-name": "SAPETLKCRM",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "7",
                      "rule-name": "7",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "SAPETLKCRM"
                      },
                      "value": "SAPETLKCRM"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "8",
                      "rule-name": "8",
                      "object-locator": {
                          "schema-name": "SNAPLOGIC",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "9",
                      "rule-name": "9",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "SNAPLOGIC"
                      },
                      "value": "SNAPLOGIC"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "10",
                      "rule-name": "10",
                      "object-locator": {
                          "schema-name": "KCRMPROC",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "11",
                      "rule-name": "11",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "KCRMPROC"
                      },
                      "value": "KCRMPROC"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "12",
                      "rule-name": "12",
                      "object-locator": {
                          "schema-name": "KULUSERMAINT",
                          "table-name": "%",
                          "table-type": "table"
                        },
                      "rule-action": "include"
                    },
                    {
                      "rule-type": "transformation",
                      "rule-id": "13",
                      "rule-name": "13",
                      "rule-action": "rename",
                      "rule-target": "schema",
                      "object-locator": {
                        "schema-name": "KULUSERMAINT"
                      },
                      "value": "KULUSERMAINT"
                    },
                    {
                      "rule-type": "selection",
                      "rule-id": "14",
                      "rule-name": "14",
                      "object-locator": {
                          "schema-name": "KULUSERMAINT",
                          "table-name": "KULUSER_MAINT_PK_SUPPORT_T",
                          "table-type": "table"
                        },
                      "rule-action": "exclude"
                    }
                ]
            }
          - 
            db_schema_name: !Ref DbSchemaName
      # https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Tasks.CustomizingTasks.TaskSettings.html
      ReplicationTaskSettings: 
        !Sub 
          - |-
            {
              "TargetMetadata": {
                "TargetSchema": "",
                "SupportLobs": true,
                "FullLobMode": true,
                "LobChunkSize": 64,
                "LimitedSizeLobMode": false,
                "LobMaxSize": 0,
                "InlineLobMaxSize": 0
              },
              "FullLoadSettings": {
                "TargetTablePrepMode": "${target_table_prep_mode}",
                "CreatePkAfterFullLoad": false,
                "StopTaskCachedChangesApplied": false,
                "StopTaskCachedChangesNotApplied": false,
                "MaxFullLoadSubTasks": ${max_full_load_sub_tasks},
                "TransactionConsistencyTimeout": 5,
                "CommitRate": 10000
              },
              "Logging": {
                "EnableLogging": ${enable_logging},
                "DeleteTaskLogs ": true,
                "LogComponents": [{
                    "Id": "SOURCE_UNLOAD",
                    "Severity": "LOGGER_SEVERITY_DEFAULT"
                  },{
                    "Id": "SOURCE_CAPTURE",
                    "Severity": "LOGGER_SEVERITY_DEFAULT"
                  },{
                    "Id": "TARGET_LOAD",
                    "Severity": "LOGGER_SEVERITY_DEFAULT"
                  },{
                    "Id": "TARGET_APPLY",
                    "Severity": "LOGGER_SEVERITY_DEFAULT"
                  },{
                    "Id": "TASK_MANAGER",
                    "Severity": "LOGGER_SEVERITY_DEFAULT"
                  }]
              },
              "ControlTablesSettings": {
                "ControlSchema": "dmslogs",
                "HistoryTimeslotInMinutes": 5,
                "HistoryTableEnabled": true,
                "SuspendedTablesTableEnabled": true,
                "StatusTableEnabled": true
              },
              "StreamBufferSettings": {
                "StreamBufferCount": 5,
                "StreamBufferSizeInMB": 16,
                "CtrlStreamBufferSizeInMB": 5
              },
              "ChangeProcessingTuning": null,
              "ChangeProcessingDdlHandlingPolicy": {
                "HandleSourceTableDropped": true,
                "HandleSourceTableTruncated": true,
                "HandleSourceTableAltered": true
              },
              "LoopbackPreventionSettings": null,
              "ValidationSettings": {
                "EnableValidation": ${enable_validation},
                "FailureMaxCount": 10000,
                "HandleCollationDiff": false,
                "RecordFailureDelayLimitInMinutes": 0,
                "SkipLobColumns": false,
                "TableFailureMaxCount": 1000,
                "ThreadCount": 5,
                "ValidationOnly": ${validation_only},
                "ValidationPartialLobSize": 0
              },
              "CharacterSetSettings": null,
              "BeforeImageSettings": null,
              "ErrorBehavior": {
                "DataErrorPolicy": "LOG_ERROR",
                "DataErrorEscalationPolicy": "SUSPEND_TABLE",
                "DataErrorEscalationCount": 50,
                "DataTruncationErrorPolicy": "LOG_ERROR",

                "TableErrorPolicy":"SUSPEND_TABLE",
                "TableErrorEscalationPolicy":"STOP_TASK",
                "TableErrorEscalationCount": 100,

                "RecoverableErrorCount": -1,
                "RecoverableErrorInterval": 5,
                "RecoverableErrorThrottling": true,
                "RecoverableErrorThrottlingMax": 1800,

                "ApplyErrorDeletePolicy": "IGNORE_RECORD",
                "ApplyErrorInsertPolicy": "LOG_ERROR",
                "ApplyErrorUpdatePolicy": "LOG_ERROR",
                "ApplyErrorEscalationPolicy": "LOG_ERROR",
                "ApplyErrorEscalationCount": 0,

                "FullLoadIgnoreConflicts": true,
                "FailOnTransactionConsistencyBreached" : ${fail_on_transaction_consistency_breached}
              }
            }
          - 
            max_full_load_sub_tasks: !FindInMap [ParallelLoadMap, !Ref ReplicationInstanceClass, parallelTasks]
            target_table_prep_mode: !Ref TargetTablePrepMode
            enable_logging: !Ref EnableLogging
            enable_validation: !Ref EnableValidation
            validation_only: !Ref ValidationOnly
            recoverable_error_count: !Ref RecoverableErrorCount
            fail_on_transaction_consistency_breached: !Ref FailOnTransactionConsistencyBreached

        
Outputs:

  DmsEndpointSource:
      Description: DMS source Endpoint
      Value: !Ref SourceEndpoint

  DmsEndpointTarget:
      Description: DMS target Endpoint
      Value: !Ref TargetEndpoint

  ReplicationInstance:
      Description: DMS Replication Instance
      Value: !Ref ReplicationInstance

  DmsReplicationTask:
      Description: DMS Replication Task
      Value: !Ref ReplicationTask
