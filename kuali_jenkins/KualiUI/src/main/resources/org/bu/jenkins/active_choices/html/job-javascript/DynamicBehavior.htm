<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

	<script th:inline="javascript" th:fragment="dynamic-behavior">	
	
		const jobName = [[${jobName}]];
		const mode = [[${mode}]];
		const ajaxHost = [[${ajaxHost}]];
		
		var newlines = (quantity) => {
			for(var i=1; i<=quantity; i++) {
				var br = document.createElement("br");
				document.body.appendChild(br);					
			}
		}
		
		/**
		 * A Formdata object is a native javascript object convenient for wrapping the name=value pairs of the 
		 * fields in a form. It can also be dynamically populated as is done in this function.
		 */
		function getFormData() {
			var formdata = new FormData();
			
		    var radios = document.querySelectorAll('#kuali-wrapper input[type=radio]');
		    radios.forEach(radio => {
		    	if(radio.checked) {
		    		formdata.set(radio.name, radio.value)
		    	}		    	
		    });
		    
		    var picklists = document.querySelectorAll('#kuali-wrapper select');
		    picklists.forEach(picklist => formdata.set(picklist.name, picklist.value));
		    
		    var textboxes = document.querySelectorAll('#kuali-wrapper input[type=text]');
		    textboxes.forEach(textbox => {
		    	if(textbox.id == [[${jobName}]]) return;
		    	formdata.set(textbox.name, textbox.value)
		    });
		    
		    var checkboxes = document.querySelectorAll('#kuali-wrapper input[type=checkbox]');
		    checkboxes.forEach(checkbox => formdata.set(checkbox.name, checkbox.checked));
		    
		    var textareas = document.querySelectorAll('#kuali-wrapper textarea');
		    textareas.forEach(textarea => formdata.set(textarea.name, textarea.value));
		    
		    return formdata;
		}
		
		/**
		 * Construct a querystring comprising the name=value pairs as you would see in a url resulting from a form GET request being issued.
		 */
		function getQuerystring(formdata) {
			var data = [...formdata.entries()];
			var querystring = data
		      .map(x => `${encodeURIComponent(x[0])}=${encodeURIComponent(x[1])}`)
		      .join('&');
			console.log(querystring);
			return querystring;
		}
		
		/**
		 * The "cascader" object is part of the uno-choices javascript library, is one per active choices parameter, has
		 * properties and methods that can be called to programatically invoke the active choices cascading update features,
		 * causing other "subscribing" parameters to autorefresh.
		 */
		function getUnoChoiceCascadeElement() {
			var x = document.getElementById(jobName);
			while(x) {
			    x = x.parentElement;
			    if(x.id) {
			        if(/^formattedHtml_choice-parameter/.test(x.id)) {
			        	var cascader = UnoChoice.cascadeParameters.find(y => y.paramElement.id == x.id);
			        	if(cascader) {
			        		return cascader;
			        	}
			        }
			    }
			}
			return {
				update: () => console.log('Arg!!! Could not find UnoChoice cascade object!')
			}
		}
		
		/**
		 * Triggered when a form field has changed (onchange, onblur, etc.)
		 */
		function sendData(recall) {
			try {
				var FD = getFormData();				
				var querystring = getQuerystring(FD);
				var fld = new function() {
					if(event.srcElement.getAttribute) {
						this.name = event.srcElement.getAttribute("name");
					}
					else {
						this.name = 'xhttp';
					}
					this.value = event.srcElement.value;
				};
				
				function callback(event) {
					document.getElementById("kuali-wrapper").innerHTML = event.target.responseText;
					if(recall) {
						/**
						 * recall means we have just done the second of two back-to-back round trips to the server.
						 * Usually only one server call is made, but in this case, the second was necessary because 
						 * the first call returned a "_PARAMETERS" field in the html content with a value that 
						 * did not contain one or more brand new fields that appeared for the first time in the html
						 * content. So, sendData must be called again to re-construct the querystring, resend it, 
						 * (with new field(s)) in order to get it back again without any missing pieces in the 
						 * "_PARAMETERS field value".
						 */ 
						return;
					}
					else if(fld.name == 'RDS_SOURCE') {
						sendData(true);
					}
				}
				
				if("undefined" !== typeof UnoChoice) {
					/** Jenkins is the host and UnoChoice indicates the presense of the active choices plugin */
					document.getElementById('all-fields').disabled = true;
					var cascader = getUnoChoiceCascadeElement();
					document.getElementById(cascader.paramName + '_PARAMETERS').value = querystring;
					cascader.update();
				}
				else {
					
					/** Must be testing (localhost is host, not jenkins) */
					var xhttp = new XMLHttpRequest();
					if(querystring) querystring=`?${querystring}`;
					
					xhttp.addEventListener("load", function(event) {
						callback(event);
				    });
					
					xhttp.addEventListener("error", function(event) {
						alert('Oops! Something went wrong.' );
					});
					
					xhttp.open("GET", "http://127.0.0.1:8001/active-choices" + querystring, true);
					xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xhttp.send(FD);
					
					document.getElementById('all-fields').disabled = true;
				}
			}
			catch(e) {
				alert(e.message);
			}
		}
	</script>

</html>