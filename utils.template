{
	"AWSTemplateFormatVersion" : "2010-09-09",

	"Description" : "One or more resources for custom logic executed by Lambda functions.",

    "Parameters" : {
		"Landscape" : {
			"Type" : "String",
			"AllowedValues" : [ "sb", "ci", "qa", "stg", "prod" ],
			"ConstraintDescription" : "This parameter is restricted to the following values: sb, ci, qa, stg, prod",
			"Default" : "sb"
		},
		"GlobalPrefix" : {
		    "Type" : "String",
			"Description": "A common value that all resources in this template will prefix to their name to establish a bundling through naming convention. If a nested stack, this will most likely be the name of the top-most stack.",
			"Default" : "ECS-test"
		}
	},

    "Metadata" : {
		"Caveats" : {"Fn::Join" : [ " ", [
		    "From https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html :",
			"1) If you specify your source code as inline text by specifying the ZipFile property within the Code property, specify index.function_name as the handler.",
			"2) The cfn-response module is available only when you use the ZipFile property to write your source code. It isn't available for source code that's stored in Amazon S3 buckets. ",
			"3) There is a 4096 character limit to text of inline code."
		]]}
	},

	"Resources" : {

		"LambdaExecutionRole" : {
		    "Type" : "AWS::IAM::Role",
		    "Properties" : {
				"RoleName" : {"Fn::Join" : [ "-", [ { "Ref" : "GlobalPrefix" }, "lambda-helper"] ]},
		        "AssumeRolePolicyDocument" : {
					"Statement": [{
						"Effect" : "Allow",
						"Principal" : {
							"Service" : [ "lambda.amazonaws.com" ]
						},
                        "Action" : [ "sts:AssumeRole" ]
					}]
		        },
                "Path" : "/",
                "ManagedPolicyArns" : [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
				]
		    }
		},

        "HelperFunction" : {
            "Type" : "AWS::Lambda::Function",
            "Properties" : {
				"Description" : "Note If you specify your source code as inline text by specifying the ZipFile property within the Code property, specify index.function_name as the handler",
                "Handler" : "index.helper",
                "Role"    : {"Fn::GetAtt" : [ "LambdaExecutionRole", "Arn"]},
                "Runtime" : "nodejs6.10",
                "FunctionName" : {"Fn::Join" : [ "-", [ { "Ref" : "GlobalPrefix" }, "lambda-helper" ] ]},
                "Code" : {
					"ZipFile" : {"Fn::Join" : [ "\n", [
						"var response = require('cfn-response');",
						"exports.helper = function (event, context) {",
						"    try {",
						"        switch(event.ResourceProperties.task) {",
						"            case 'add': ",
						"                var result = parseInt(event.ResourceProperties.parm1) + parseInt(event.ResourceProperties.parm2); ",
						"                response.send(event, context, response.SUCCESS, { Value: result });",
						"                break;",
						"            case 'subtract': ",
						"                var result = parseInt(event.ResourceProperties.parm1) - parseInt(event.ResourceProperties.parm2); ",
						"                response.send(event, context, response.SUCCESS, { Value: result });",
						"                break;",
						"            case 'cluster-size': ",
						"                var desiredCapacity = parseInt(event.ResourceProperties.parm1);",
						"                var min = desiredCapacity < 2 ? 1 : (desiredCapacity - 1); ",
						"                var max = desiredCapacity + 1; ",
						"                var json = { minSize: min, maxSize: max }; ",
						"                response.send(event, context, response.SUCCESS, json);",
						"                break;",
						"            default: ",
						"                var msg = 'Unexpected/Missing task parameter!'; ",
						"                throw new Error(msg);",
						"        }",
						"    }",
						"    catch(e) {",
						"        console.error(e);",
						"        response.send(event, context, response.FAILURE, { Value: { error: { name: e.name, message: e.message } }});",
						"    }",
						"};"
					]]}
				}
            }
        }
	},

	"Outputs" : {
		"HelperFunctionArn" : {
		 "Value" : {"Fn::GetAtt" : [ "HelperFunction", "Arn"]}
		},
		"ExecutionRole" : {
		    "Value" : { "Ref" : "LambdaExecutionRole" }
		}
	}
}
